define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_events","core/modal_factory","block_enrolcode/modal_code","block_enrolcode/modal_enter"],function(d,g,e,a,c,f,j,h,b,i){return{debug:true,deleteCode:function(k,l){g.call([{methodname:"block_enrolcode_delete",args:{code:k},done:function(m){if(m=="1"){if(typeof(l)!=="undefined"){d("#block_enrolcode_old_codes-"+l+" [data-code="+k+"]").remove();d("#enrolcode-"+l).addClass("hidden")}}else{alert(m)}},fail:e.exception}])},fullsizeCode:function(o,l){if(this.debug){console.log("block_enrolcode/main::fullsizeCode(uniqid, subid)",o,l)}var n="#enrolcode-item-"+o+"-"+l;var m=d(n);var k=["accesscode","group","maturity","enrolmentend","role"];k.forEach(function(p){d("#enrolcode-"+o+" ."+p).html(d(n+" ."+p).html())});d("#enrolcode-"+o+" .url").attr("href",d(n+" .accesscode").attr("href"));d("#enrolcode-"+o+" .qr").attr("src",d(n+" .qr").attr("src"));d("#enrolcode-"+o).removeClass("hidden")},generateEnrolURL:function(k){return f.relativeUrl("/blocks/enrolcode/enrol.php?code="+k)},getCode:function(l){this.injectCSS();var o=this;console.log("MAIN.getCode(src)",l);var m=d(l).closest("form");var t=+d(m).find('[name="courseid"]').val();var n=+d(m).find('[name="roleid"]').val();var q=+d(m).find('[name="groupid"]').val();var p=d(m).find('[name="custommaturity"]').is(":checked")?1:0;var r=d(m).find('[name="chkenrolmentend"]').is(":checked")?1:0;var k=new Date(d(m).find("#id_maturity_year").val(),d(m).find("#id_maturity_month").val()-1,d(m).find("#id_maturity_day").val(),d(m).find("#id_maturity_hour").val(),d(m).find("#id_maturity_minute").val(),0,0);var u=new Date(d(m).find("#id_enrolmentend_year").val(),d(m).find("#id_enrolmentend_month").val()-1,d(m).find("#id_enrolmentend_day").val(),d(m).find("#id_enrolmentend_hour").val(),d(m).find("#id_enrolmentend_minute").val(),0,0);var s={courseid:t,roleid:n,groupid:q,custommaturity:p,maturity:Math.ceil(k.getTime()/1000),chkenrolmentend:r,enrolmentend:Math.ceil(u.getTime()/1000)};console.log(s);g.call([{methodname:"block_enrolcode_get",args:s,done:function(v){if(v!=""&&v!=null){console.log("Got code",v);h.create({type:b.TYPE,}).then(function(x){var w=x.getRoot();d(w).find("#code").html(v);d(w).find("#enrolurl").val(o.generateEnrolURL(v));d(w).find("#qrcode").attr("src",f.relativeUrl("/blocks/enrolcode/pix/qr.php?format=base64&txt="+btoa(o.generateEnrolURL(v))));x.show()})}else{h.create({type:h.types.OK,title:"Error",body:c.render("block_enrolcode/code_get_error",{}),}).then(function(w){w.show()})}},fail:e.exception}])},getCodeModal:function(k){this.injectCSS();g.call([{methodname:"block_enrolcode_form",args:{courseid:k},done:function(l){a.get_strings([{key:"code:get",component:"block_enrolcode"},]).done(function(m){h.create({type:h.types.OK,title:m[0],body:l,large:true,}).then(function(o){var n=o.getRoot();n.on(j.OK,function(){console.log("Hiding modal");o.hide()});o.show()})}).fail(e.exception)},fail:e.exception}])},injectButton:function(k){if(typeof k==="undefined"||k<=1){return}a.get_strings([{key:"code:get",component:"block_enrolcode"},]).done(function(l){d("#page-content div.enrolusersbutton").parent().prepend(d('<div class="singlebutton enrolusersbutton block_enrolcode">').append(d('<a href="#" onclick="require([\'block_enrolcode/main\'], function(MAIN) { MAIN.getCodeModal('+k+'); }); return false;" class="btn btn-secondary my-1">'+l[0]+"</a>")))}).fail(e.exception)},injectCSS:function(){if(d('head>link[href$="/blocks/enrolcode/style/enrolcode.css"]').length==0){console.log("Adding CSS File ",f.relativeUrl("/blocks/enrolcode/style/enrolcode.css"));d("head").append(d('<link rel="stylesheet" type="text/css" href="'+f.relativeUrl("/blocks/enrolcode/style/enrolcode.css")+'">'))}},injectMainmenuButton:function(){a.get_strings([{key:"code:accesscode",component:"block_enrolcode"},]).done(function(k){d('.usermenu .dropdown a[href$="/user/preferences.php"]').after(d("<a>").attr("href","#").attr("onclick","require(['block_enrolcode/main'], function(MAIN) { MAIN.sendCodeModal(); }); return false;").addClass("dropdown-item menu-action").attr("role","menuitem").attr("data-title","moodle,accesscard").attr("aria-labelledby","actionmenuaction-accesscard").attr("data-ajax","false").append([d("<i>").addClass("icon fa fa-key fa-fw").attr("aria-hidden","true"),d("<span>").addClass("menu-action-text").attr("id","actionmenuaction-accesscard").html(k[0]),]))}).fail(e.exception)},revokeCode:function(l){this.injectCSS();var k=this;console.log("MAIN.revokeCode(code)",l);g.call([{methodname:"block_enrolcode_revoke",args:{code:l},done:function(m){},fail:e.exception}])},sendCode:function(m,l){this.injectCSS();var k=this;console.log("MAIN.sendCode(uniqid, code)",m,l);if(typeof m!=="undefined"&&m!=""){l=d("#code-"+m).val()}g.call([{methodname:"block_enrolcode_send",args:{code:l},done:function(n){console.log("Got courseid ",n);if(n>1){top.location.href=f.relativeUrl("/course/view.php?id="+n,{})}else{h.create({type:h.types.OK,title:"Error",body:"Invalid code",}).then(function(o){o.show()})}},fail:e.exception}])},sendCodeModal:function(){this.injectCSS();h.create({type:i.TYPE}).then(function(k){k.show()})},shareCode:function(m){console.log("MAIN.shareCode(src)",m);var l=d(m).attr("data-target");var k=d(m).closest(".container").find("#code").html();var n=MAIN.generateEnrolURL(k);switch(l){case"facebook":window.open("https://www.facebook.com/sharer.php?u="+encodeURI(n));break}}}});